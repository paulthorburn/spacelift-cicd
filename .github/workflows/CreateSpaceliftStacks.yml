name: Create Spacelift Stacks

on:
  push:
    branches: [main, master]
    paths:
      - '**/*.tf'

env:
  SPACELIFT_API_KEY_ENDPOINT: https://o2ebrands.app.spacelift.io
  SPACELIFT_API_KEY_ID: ${{ secrets.SPACELIFT_API_KEY_ID }}
  SPACELIFT_API_KEY_SECRET: ${{ secrets.SPACELIFT_API_KEY_SECRET }}

jobs:
  create-stacks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install Spacelift CLI
        uses: spacelift-io/setup-spacectl@main
        with:
          version: latest

      - name: Get changed Terraform directories and create stacks
        run: |
          #!/bin/bash
          set -e

          # Space ID mapping
          declare -A SPACE_IDS=(
            ["itops"]="01KEFW3X8XZ2RBXYMZM87GP465"
            ["salesforce-archive"]="01KEFW3X6GYK42PSP8GP1MC4R2"
            ["sandbox"]="01KEFW3X89EHBRHQNY4NAGCE28"
          )

          # Get list of changed .tf files and extract unique directories
          echo "ğŸ” Getting changed Terraform files..."
          
          # Handle initial commit vs subsequent commits
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep '\.tf$' | xargs -I{} dirname {} | sort -u || true)
          else
            # Initial commit - get all .tf files
            CHANGED_DIRS=$(git ls-tree -r --name-only HEAD | grep '\.tf$' | xargs -I{} dirname {} | sort -u || true)
          fi

          if [ -z "$CHANGED_DIRS" ]; then
            echo "ğŸ“­ No Terraform directories changed in this commit"
            exit 0
          fi

          echo "ğŸ“ Changed Terraform directories:"
          echo "$CHANGED_DIRS"
          echo ""

          # Process each unique directory
          for dir in $CHANGED_DIRS; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‚ Processing: $dir"
            
            # Extract components from path (e.g., sandbox/us-east-1/demo)
            root_folder=$(echo "$dir" | cut -d'/' -f1)
            region=$(echo "$dir" | cut -d'/' -f2)
            
            # Get space ID for this root folder
            space_id="${SPACE_IDS[$root_folder]}"
            
            if [ -z "$space_id" ]; then
              echo "âš ï¸  Warning: No space ID mapping found for '$root_folder', skipping..."
              continue
            fi

            # Create stack name from directory path (replace / with -)
            stack_name=$(echo "$dir" | sed 's/\//-/g')
            
            echo "   Stack Name: $stack_name"
            echo "   Space ID: $space_id"
            echo "   Region: $region"

            # Check if stack already exists using spacectl
            echo "ğŸ” Checking if stack exists..."
            if spacectl stack show --id "$stack_name" > /dev/null 2>&1; then
              echo "âœ… Stack '$stack_name' already exists"
              continue
            fi

            # Create the stack using spacectl
            echo "ğŸš€ Creating stack '$stack_name'..."
            
            spacectl stack create \
              --name "$stack_name" \
              --space "$space_id" \
              --repository "${{ github.repository }}" \
              --branch "${{ github.ref_name }}" \
              --project-root "$dir" \
              --vendor terraform \
              --terraform-version "1.5.0" \
              --administrative=false \
              --autodeploy=false \
              --label "auto-created"

            if [ $? -ne 0 ]; then
              echo "âŒ Failed to create stack '$stack_name'"
              continue
            fi

            echo "âœ… Stack '$stack_name' created successfully"

            # Add TF_VAR_region environment variable
            echo "ğŸ”§ Adding TF_VAR_region environment variable..."
            spacectl stack environment setvar \
              --id "$stack_name" \
              --name "TF_VAR_region" \
              --value "$region" \
              --plaintext

            if [ $? -eq 0 ]; then
              echo "âœ… TF_VAR_region set to '$region'"
            else
              echo "âš ï¸  Warning: Failed to add TF_VAR_region"
            fi

            echo ""
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Stack creation process complete!"
